!function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=17)}([function(t,e,s){"use strict";s.d(e,"b",(function(){return Utils})),s.d(e,"a",(function(){return i}));class Utils{static log(t,e=i.INFO){const s=`[${(new Date).toTimeString().split(" ")[0]}]: `;switch(e){case i.INFO:console.log(s+"%c[1mi[0m "+t,"font-weight:bold;");break;case i.OK:console.log(s+"[32m[1m%câœ“ "+t+"[0m","color:green;font-weight:bold;");break;case i.ERROR:console.error(s+"[31m[1m%câœ˜ "+t+"[0m","color:red;font-weight:bold;");break;case i.WARNING:console.log(s+"[33m[1m%c![0m [33m"+t+"[0m","color:goldenrod;font-weight:bold;");break;case i.DIVIDER:{const e="=".repeat(30-t.length/2);console.log(e+t+e+(t.length%2?"=":""));break}default:throw new TypeError("Unknown log type!")}}}var i;!function(t){t[t.INFO=0]="INFO",t[t.OK=1]="OK",t[t.WARNING=2]="WARNING",t[t.ERROR=3]="ERROR",t[t.DIVIDER=4]="DIVIDER"}(i||(i={}))},function(t,e,s){"use strict";function i(){class Service{static addEventListener(t,e){t in this.callbacks||(this.callbacks[t]=[]),this.callbacks[t].push(e)}static call(t,...e){this.callbacks[t]&&this.callbacks[t].map(t=>t.call(t,...e))}static expose(t,e=null){if(window[this.name]||(window[this.name]={}),e)window[this.name][t]=e;else{if("function"!=typeof this[t])throw new Error("The function to expose not found!");window[this.name][t]=(...e)=>{this[t].call(this,...e)}}}static close(){this.callbacks={}}}return Service.callbacks={},Service}s.d(e,"a",(function(){return i}))},function(t,e,s){"use strict";s.d(e,"a",(function(){return Database}));var i=s(15),n=s.n(i),a=s(3),r=s.n(a),o=s(1);class Database extends(Object(o.a)()){static async initialize(){r.a.existsSync("./data")||r.a.mkdirSync("./data"),this.database=new n.a.Database("./data/sessions.db"),this.database.parallelize(()=>{if(!this.database)return;let t="CREATE TABLE IF NOT EXISTS sessions (";t+="    user_id TEXT NOT NULL,",t+="    platform INTEGER NOT NULL,",t+="    time_from DATE NOT NULL,",t+="    time_to DATE NOT NULL",t+=");",this.database.run(t),t="CREATE TABLE IF NOT EXISTS users (",t+="    id TEXT PRIMARY KEY,",t+="    name TEXT NOT NULL",t+=");",this.database.run(t)})}static async createUser(t){if(!this.database)return;let e="INSERT INTO users (id, name) ";e+="VALUES($id, $name) ",e+="EXCEPT ",e+="SELECT id, name FROM users",this.database.run("INSERT INTO users (id, name) VALUES($id, $name) EXCEPT SELECT id, name FROM users",{$id:t.id,$name:t.name})}static async addSession(t){if(!this.database)return;if(!t.to)return;let e="INSERT INTO sessions (user_id, platform, time_from, time_to)";e+="VALUES($userId, $platform, $from, $to)",this.database.run("INSERT INTO sessions (user_id, platform, time_from, time_to)VALUES($userId, $platform, $from, $to)",{$userId:t.userId,$platform:t.platform,$from:t.from.toISOString().slice(0,19).replace("T"," "),$to:t.to.toISOString().slice(0,19).replace("T"," ")})}static async getNames(t="all"){return new Promise((e,s)=>{if(!this.database)return s(new Error("Database is not initialized!"));this.database.all("SELECT * FROM users WHERE id=$id or $id='all'",{$id:t},(t,i)=>t?s(t):e(i))})}static async getDays(t="all"){return new Promise((e,s)=>{if(!this.database)return s(new Error("Database is not initialized!"));let i="SELECT";i+="\tid,",i+="\tROUND((",i+="\t\tSELECT JULIANDAY(MAX(time_to)) FROM sessions",i+="\t\tWHERE user_id = id",i+="\t) -",i+="\t(",i+="\t\tSELECT JULIANDAY(MIN(time_from)) FROM sessions",i+="\t\tWHERE user_id = id",i+="\t) + 0.5) as days ",i+="FROM users WHERE id = $id or $id='all'",this.database.all("SELECT\tid,\tROUND((\t\tSELECT JULIANDAY(MAX(time_to)) FROM sessions\t\tWHERE user_id = id\t) -\t(\t\tSELECT JULIANDAY(MIN(time_from)) FROM sessions\t\tWHERE user_id = id\t) + 0.5) as days FROM users WHERE id = $id or $id='all'",{$id:t},(t,i)=>t?s(t):e(i))})}static async getUsers(t="all"){return new Promise((e,s)=>{if(!this.database)return s(new Error("Database is not initialized!"));let i="SELECT";i+="\tid, name,",i+="\tROUND((",i+="\t\tSELECT JULIANDAY(MAX(time_to)) FROM sessions",i+="\t\tWHERE user_id = id",i+="\t) -",i+="\t(",i+="\t\tSELECT JULIANDAY(MIN(time_from)) FROM sessions",i+="\t\tWHERE user_id = id",i+="\t) + 0.5) as days ",i+="FROM users WHERE id = $id or $id='all'",this.database.all("SELECT\tid, name,\tROUND((\t\tSELECT JULIANDAY(MAX(time_to)) FROM sessions\t\tWHERE user_id = id\t) -\t(\t\tSELECT JULIANDAY(MIN(time_from)) FROM sessions\t\tWHERE user_id = id\t) + 0.5) as days FROM users WHERE id = $id or $id='all'",{$id:t},(t,i)=>t?s(t):e(i))})}static async getSessions(t="all",e=30,s=0){return new Promise((i,n)=>{if(!this.database)return n(new Error("Database is not initialized!"));let a="SELECT";a+="  JSON_OBJECT('id', id, 'sessions', (",a+="    SELECT JSON_GROUP_ARRAY(",a+="      JSON_OBJECT(",a+="        'platform', platform,",a+="        'from', CAST(STRFTIME('%s', time_from) as INT),",a+="        'to', CAST(STRFTIME('%s', time_to) as INT)))",a+="    FROM sessions WHERE (user_id = id) AND (",a+="    ROUND(JULIANDAY(time_from)) < (",a+="    SELECT (ROUND(JULIANDAY(MIN(time_from)))",a+="    + $count + $offset)",a+="      FROM sessions as temp",a+="      WHERE temp.user_id = user_id",a+="    )) AND (",a+="    ROUND(JULIANDAY(time_to)) >= (",a+="      SELECT (ROUND(JULIANDAY(MIN(time_from))) + $offset)",a+="      FROM sessions as temp",a+="      WHERE temp.user_id = user_id",a+="  )))) as data ",a+="FROM users WHERE id = $userId or $userId = 'all'",this.database.all("SELECT  JSON_OBJECT('id', id, 'sessions', (    SELECT JSON_GROUP_ARRAY(      JSON_OBJECT(        'platform', platform,        'from', CAST(STRFTIME('%s', time_from) as INT),        'to', CAST(STRFTIME('%s', time_to) as INT)))    FROM sessions WHERE (user_id = id) AND (    ROUND(JULIANDAY(time_from)) < (    SELECT (ROUND(JULIANDAY(MIN(time_from)))    + $count + $offset)      FROM sessions as temp      WHERE temp.user_id = user_id    )) AND (    ROUND(JULIANDAY(time_to)) >= (      SELECT (ROUND(JULIANDAY(MIN(time_from))) + $offset)      FROM sessions as temp      WHERE temp.user_id = user_id  )))) as data FROM users WHERE id = $userId or $userId = 'all'",{$userId:t,$count:e,$offset:s},(t,e)=>t?n(t):i(e.map(t=>JSON.parse(t.data))))})}static close(){super.close(),this.database&&this.database.close()}}Database.database=null},function(t,e){t.exports=require("fs")},function(t,e,s){"use strict";s.d(e,"b",(function(){return User})),s.d(e,"a",(function(){return i}));class User{constructor(t,e,s=!1,i={lastSeen:new Date,platform:0}){this.id=t,this.name=e,this.online=s,this.details=i}compare(t){if(t.id!=this.id)throw new Error("Cannot compare different users.");return!this.online&&t.online?new Action(t,i.LOGGED_IN):this.online&&!t.online?new Action(t,i.LOGGED_OUT):new Action(t,i.UNCHANGED)}static compareUsers(t,e){const s=[];for(const n of t){const t=e.find(t=>t.id==n.id);if(t){const e=n.compare(t);e.type!=i.UNCHANGED&&s.push(e)}else s.push(new Action(n,i.LOGGED_OUT))}for(const n of e){t.find(t=>t.id==n.id)||(s.push(new Action(n,i.CREATED)),n.online&&s.push(new Action(n,i.LOGGED_IN)))}return s}}class Action{constructor(t,e){this.user=t,this.type=e}}var i;!function(t){t[t.UNCHANGED=0]="UNCHANGED",t[t.LOGGED_IN=1]="LOGGED_IN",t[t.LOGGED_OUT=2]="LOGGED_OUT",t[t.CREATED=3]="CREATED"}(i||(i={}))},function(t,e,s){"use strict";s.d(e,"a",(function(){return Watcher}));var i=s(1),n=s(4);class Watcher extends(Object(i.a)()){static async initialize(t,e=3e4){this.api=t,this.users=[];const s=this.watch.bind(this);this.timer=setInterval(s,e),setTimeout(s,10)}static async watch(){if(!this.api||!this.users)return;const t=await this.api.getFrieds(),e=n.b.compareUsers(this.users,t);for(const t of e)switch(t.type){case n.a.CREATED:this.call("created",t.user);break;case n.a.LOGGED_IN:this.call("loggedin",t.user);break;case n.a.LOGGED_OUT:this.call("loggedout",t.user)}this.users=t}static close(){super.close(),null!=this.timer&&(clearInterval(this.timer),this.timer=null,this.users=null)}}Watcher.api=null,Watcher.users=null,Watcher.timer=null},function(t,e,s){"use strict";s.d(e,"a",(function(){return Sessions}));var i=s(1);class Sessions extends(Object(i.a)()){static async initialize(){this.sessions={}}static registerLogIn(t){this.sessions[t.id]||(this.sessions[t.id]={userId:t.id,platform:t.details.platform,from:t.details.lastSeen,to:null})}static registerLogOut(t){const e=this.sessions[t.id];e&&(e.to=t.details.lastSeen,e.platform=t.details.platform,+e.from>=+e.to&&(e.to=new Date(+e.from+5e3)),this.call("sessionfound",e),this.sessions[t.id]=null)}static close(){super.close();const t=new Date;for(const e of Object.values(this.sessions))e&&+t-+e.from>3e5&&(e.to=t,this.call("sessionfound",e),this.sessions[e.userId]=null)}}},function(t,e){t.exports=require("request-promise-native")},function(t,e){t.exports=require("express")},function(t,e){t.exports=require("body-parser")},function(t,e){t.exports=require("dotenv")},function(t,e,s){"use strict";s.d(e,"a",(function(){return App}));var i=s(12),n=s(13),a=s(5),r=s(14),o=s(2),c=s(6),l=s(16);class App{constructor(){this.manger=null}async initialize(){const t=[c.a,a.a,o.a,l.a,r.a];this.manger=new i.a(t);const e=await this.initializeArguments();await this.manger.initialize(e)}async initializeArguments(){if(!this.manger)throw new Error("Initialize manager first!");if(!process.env.VK_API_TOKEN)throw new Error("VK api token not found in .env file!");return{Watcher:[new n.a(process.env.VK_API_TOKEN)]}}close(){this.manger&&(this.manger.close(),this.manger=null)}get initialized(){return null!=this.manger}set logging(t){this.manger&&(this.manger.logging=t)}get logging(){return!!this.manger&&this.manger.logging}}},function(t,e,s){"use strict";s.d(e,"a",(function(){return Manager}));var i=s(0);class Manager{constructor(t,e=[]){this.logging=!0,this.components=t,this.views=e}async initialize(t=[],e=[]){let s=0;this.logging&&i.b.log("Initializtion started..."),this.logging&&this.views.length>0&&i.b.log("Views",i.a.DIVIDER);for(const t in this.views){const n=this.views[t];try{const s=Array.isArray(e)?e[t]:e[n.name];s?await n.render(null,s):await n.render(),this.logging&&i.b.log(`${n.name} rendered!`,i.a.OK)}catch(t){this.logging&&i.b.log(`${n.name} render exception:\n\t`+`${t.stack.replace(/\n/g,"\n\t")}`,i.a.ERROR),s++}}this.logging&&this.components.length>0&&i.b.log("Components",i.a.DIVIDER);for(const e in this.components){const n=this.components[e];try{const s=Array.isArray(t)?t[e]:t[n.name];s?await n.initialize(...s):await n.initialize(),this.logging&&i.b.log(`${n.name} initialized!`,i.a.OK)}catch(t){this.logging&&i.b.log(`${n.name} initialization exception:\n\t`+`${t.stack.replace(/\n/g,"\n\t")}`,i.a.ERROR),s++}}this.logging&&(i.b.log("",i.a.DIVIDER),s?i.b.log(`Initialization completed with ${s} exceptions!`,i.a.WARNING):i.b.log("Successfyly initialized!",i.a.OK))}getComponent(t){return this.components.find(e=>e.name.toLowerCase()==t.toLowerCase())||null}getView(t){return this.views.find(e=>e.name.toLowerCase()==t.toLowerCase())||null}close(){this.logging&&(i.b.log("",i.a.DIVIDER),i.b.log("Closing all components..."));let t=0;for(const e of this.components)try{e.close(),this.logging&&i.b.log(`${e.name} closed!`,i.a.OK)}catch(s){this.logging&&i.b.log(`${e.name} closing exception:\n\t`+`${s.stack.replace(/\n/g,"\n\t")}`,i.a.ERROR),t++}this.logging&&(i.b.log("",i.a.DIVIDER),t?i.b.log(`Stopped with ${t} exceptions!`,i.a.WARNING):i.b.log("Successfyly stopped!",i.a.OK))}}},function(t,e,s){"use strict";s.d(e,"a",(function(){return Api}));var i=s(7),n=s.n(i),a=s(4);class Api{constructor(t){this.url="https://api.vk.com/method/",this.params={access_token:t,v:"5.101"}}async getFrieds(){const t=await n.a.post(this.url+"friends.get",{form:Object.assign(Object.assign({},this.params),{fields:"last_seen,online"})}),e=JSON.parse(t);if("object"!=typeof e.response)return[];if(!Array.isArray(e.response.items))return[];const s=[];for(const t of e.response.items){if(!t.id||!t.first_name||!t.last_name||"number"!=typeof t.online)continue;let e=void 0;if("object"==typeof t.last_seen){const s=1e3*+t.last_seen.time,i=+t.last_seen.platform||0;e={lastSeen:s?new Date(s):new Date,platform:i}}const i=new a.b(t.id+"",t.first_name+" "+t.last_name,t.online+""=="1",e);s.push(i)}return s}async getOnline(){const t=await n.a.post(this.url+"friends.getOnline",{form:Object.assign(Object.assign({},this.params),{online_mobile:"0"})}),e=JSON.parse(t);return Array.isArray(e.response)?e.response:[]}}},function(t,e,s){"use strict";s.d(e,"a",(function(){return Envets}));var i=s(1),n=s(5),a=s(0),r=s(2),o=s(6);class Envets extends(Object(i.a)()){static async initialize(){this.registerWatcher(),this.registerSessions(),this.call("registered")}static registerWatcher(){n.a.addEventListener("loggedin",t=>{a.b.log("[1m"+t.name+"[0m back [94monline[0m."),o.a.registerLogIn(t)}),n.a.addEventListener("loggedout",t=>{a.b.log("[1m"+t.name+"[0m left [33moffline[0m."),o.a.registerLogOut(t)}),n.a.addEventListener("created",t=>{r.a.createUser(t)})}static registerSessions(){o.a.addEventListener("sessionfound",t=>{r.a.addSession(t)})}}},function(t,e){t.exports=require("sqlite3")},function(t,e,s){"use strict";s.d(e,"a",(function(){return Server}));var i=s(8),n=s.n(i),a=s(9),r=s.n(a),o=s(1),c=s(2);class Server extends(Object(o.a)()){static async initialize(){const t=n()();t.use(n.a.static("public")),t.use(r.a.json()),t.use(r.a.urlencoded({extended:!0})),this.initRoutes(t),this.server=t.listen(80)}static initRoutes(t){t.get("/api/users/get/:id",async(t,e)=>{const s=await c.a.getUsers(t.params.id);e.send(1==s.length?s[0]:s)}),t.get("/api/users/name/:id",async(t,e)=>{const s=await c.a.getNames(t.params.id);e.send(1==s.length?s[0]:s)}),t.get("/api/users/days/:id",async(t,e)=>{const s=await c.a.getDays(t.params.id);e.send(1==s.length?s[0]:s)}),t.get("/api/sessions/get/:userId/:count?/:offset?",async(t,e)=>{const s=t.params,i=await c.a.getSessions(s.userId,Number.isInteger(+s.count)?+s.count:void 0,Number.isInteger(+s.offset)?+s.offset:void 0);e.send(1==i.length?i[0]:i)})}static close(){super.close(),this.server&&this.server.close()}}Server.server=null},function(t,e,s){"use strict";s.r(e);var i=s(10),n=s.n(i),a=s(3),r=s.n(a),o=s(0),c=s(11);n.a.config();const l=new c.a;function u(){l.close(),process.exit()}function d(t){const e=(t.stack||"").replace(/\n/g,"\n\t"),s=`./crashes/${(new Date).toDateString()}.txt`,i=`Runtime exception:\n\t${e}`,n=`[${(new Date).toTimeString()}]: ${i}\r\n\r\n`;r.a.existsSync("./crashes")||r.a.mkdirSync("./crashes"),r.a.appendFileSync(s,n),o.b.log(i,o.a.ERROR),l.logging=!1,l.close(),o.b.log("Restarting the script in 3 seconds..."),setTimeout(()=>{l.initialized||l.initialize()},3e3)}process.on("exit",l.close.bind(l)),process.on("SIGINT",u),process.on("SIGUSR1",u),process.on("SIGUSR2",u),process.on("uncaughtException",d),process.on("unhandledRejection",d),l.initialize()}]);