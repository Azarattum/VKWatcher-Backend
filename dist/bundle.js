!function(e){var t={};function s(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,s),i.l=!0,i.exports}s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)s.d(n,i,function(t){return e[t]}.bind(null,i));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=14)}([function(e,t,s){"use strict";s.d(t,"b",(function(){return Utils})),s.d(t,"a",(function(){return n}));class Utils{static log(e,t=n.INFO){const s=`[${(new Date).toTimeString().split(" ")[0]}]: `;switch(t){case n.INFO:console.log(s+"%c[1mi[0m "+e,"font-weight:bold;");break;case n.OK:console.log(s+"[32m[1m%câœ“ "+e+"[0m","color:green;font-weight:bold;");break;case n.ERROR:console.error(s+"[31m[1m%câœ˜ "+e+"[0m","color:red;font-weight:bold;");break;case n.WARNING:console.log(s+"[33m[1m%c![0m [33m"+e+"[0m","color:goldenrod;font-weight:bold;");break;case n.DIVIDER:{const t="=".repeat(30-e.length/2);console.log(t+e+t+(e.length%2?"=":""));break}default:throw new TypeError("Unknown log type!")}}}var n;!function(e){e[e.INFO=0]="INFO",e[e.OK=1]="OK",e[e.WARNING=2]="WARNING",e[e.ERROR=3]="ERROR",e[e.DIVIDER=4]="DIVIDER"}(n||(n={}))},function(e,t,s){"use strict";function n(){class Service{static addEventListener(e,t){e in this.callbacks||(this.callbacks[e]=[]),this.callbacks[e].push(t)}static call(e,...t){this.callbacks[e]&&this.callbacks[e].map(e=>e.call(e,...t))}static expose(e,t=null){if(window[this.name]||(window[this.name]={}),t)window[this.name][e]=t;else{if("function"!=typeof this[e])throw new Error("The function to expose not found!");window[this.name][e]=(...t)=>{this[e].call(this,...t)}}}static close(){this.callbacks={}}}return Service.callbacks={},Service}s.d(t,"a",(function(){return n}))},function(e,t){e.exports=require("fs")},function(e,t,s){"use strict";s.d(t,"b",(function(){return User})),s.d(t,"a",(function(){return n}));class User{constructor(e,t,s=!1,n={lastSeen:new Date,platform:0}){this.id=e,this.name=t,this.online=s,this.details=n}compare(e){if(e.id!=this.id)throw new Error("Cannot compare different users.");return!this.online&&e.online?new Action(e,n.LOGGED_IN):this.online&&!e.online?new Action(e,n.LOGGED_OUT):new Action(e,n.UNCHANGED)}static compareUsers(e,t){const s=[];for(const i of e){const e=t.find(e=>e.id==i.id);if(e){const t=i.compare(e);t.type!=n.UNCHANGED&&s.push(t)}else s.push(new Action(i,n.LOGGED_OUT))}for(const i of t){e.find(e=>e.id==i.id)||(s.push(new Action(i,n.CREATED)),i.online&&s.push(new Action(i,n.LOGGED_IN)))}return s}}class Action{constructor(e,t){this.user=e,this.type=t}}var n;!function(e){e[e.UNCHANGED=0]="UNCHANGED",e[e.LOGGED_IN=1]="LOGGED_IN",e[e.LOGGED_OUT=2]="LOGGED_OUT",e[e.CREATED=3]="CREATED"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return Watcher}));var n=s(1),i=s(3);class Watcher extends(Object(n.a)()){static async initialize(e,t=3e4){this.api=e,this.users=[];const s=this.watch.bind(this);this.timer=setInterval(s,t),setTimeout(s,10)}static async watch(){if(!this.api||!this.users)return;const e=await this.api.getFrieds(),t=i.b.compareUsers(this.users,e);for(const e of t)switch(e.type){case i.a.CREATED:this.call("created",e.user);break;case i.a.LOGGED_IN:this.call("loggedin",e.user);break;case i.a.LOGGED_OUT:this.call("loggedout",e.user)}this.users=e}static close(){super.close(),null!=this.timer&&(clearInterval(this.timer),this.timer=null,this.users=null)}}Watcher.api=null,Watcher.users=null,Watcher.timer=null},function(e,t,s){"use strict";s.d(t,"a",(function(){return Sessions}));var n=s(1);class Sessions extends(Object(n.a)()){static async initialize(){this.sessions={}}static registerLogIn(e){this.sessions[e.id]||(this.sessions[e.id]={userId:e.id,platform:e.details.platform,from:e.details.lastSeen,to:null})}static registerLogOut(e){const t=this.sessions[e.id];t&&(t.to=e.details.lastSeen,t.platform=e.details.platform,+t.from>=+t.to&&(t.to=new Date(+t.from+5e3)),this.call("sessionfound",t),this.sessions[e.id]=null)}static close(){super.close();const e=new Date;for(const t of Object.values(this.sessions))t&&+e-+t.from>3e5&&(t.to=e,this.call("sessionfound",t),this.sessions[t.userId]=null)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return Database}));var n=s(13),i=s.n(n),o=s(2),a=s.n(o),r=s(1);class Database extends(Object(r.a)()){static async initialize(){a.a.existsSync("./data")||a.a.mkdirSync("./data"),this.database=new i.a.Database("./data/sessions.db"),this.database.parallelize(()=>{let e="CREATE TABLE IF NOT EXISTS sessions (";e+="    user_id TEXT NOT NULL,",e+="    platform INTEGER NOT NULL,",e+="    time_from DATE NOT NULL,",e+="    time_to DATE NOT NULL",e+=");",this.database.run(e),e="CREATE TABLE IF NOT EXISTS users (",e+="    id TEXT PRIMARY KEY,",e+="    name TEXT NOT NULL",e+=");",this.database.run(e)})}static async createUser(e){let t="INSERT INTO users (id, name) ";t+="VALUES($id, $name) ",t+="EXCEPT ",t+="SELECT id, name FROM users",this.database.run("INSERT INTO users (id, name) VALUES($id, $name) EXCEPT SELECT id, name FROM users",{$id:e.id,$name:e.name})}static async addSession(e){let t="INSERT INTO sessions (user_id, platform, time_from, time_to)";t+="VALUES($userId, $platform, $from, $to)",this.database.run("INSERT INTO sessions (user_id, platform, time_from, time_to)VALUES($userId, $platform, $from, $to)",{$userId:e.userId,$platform:e.platform,$from:e.from,$to:e.to})}static close(){super.close(),this.database.close()}}},function(e,t){e.exports=require("request-promise-native")},function(e,t){e.exports=require("dotenv")},function(e,t,s){"use strict";s.d(t,"a",(function(){return App}));var n=s(10),i=s(11),o=s(4),a=s(12),r=s(6),c=s(5);class App{constructor(){this.manger=null}async initialize(){const e=[c.a,o.a,r.a,a.a];this.manger=new n.a(e);const t=await this.initializeArguments();await this.manger.initialize(t)}async initializeArguments(){if(!this.manger)throw new Error("Initialize manager first!");if(!process.env.VK_API_TOKEN)throw new Error("VK api token not found in .env file!");return{Watcher:[new i.a(process.env.VK_API_TOKEN)]}}close(){this.manger&&(this.manger.close(),this.manger=null)}get initialized(){return null!=this.manger}set logging(e){this.manger&&(this.manger.logging=e)}get logging(){return!!this.manger&&this.manger.logging}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return Manager}));var n=s(0);class Manager{constructor(e,t=[]){this.logging=!0,this.components=e,this.views=t}async initialize(e=[],t=[]){let s=0;this.logging&&n.b.log("Initializtion started..."),this.logging&&this.views.length>0&&n.b.log("Views",n.a.DIVIDER);for(const e in this.views){const i=this.views[e];try{const s=Array.isArray(t)?t[e]:t[i.name];s?await i.render(null,s):await i.render(),this.logging&&n.b.log(`${i.name} rendered!`,n.a.OK)}catch(e){this.logging&&n.b.log(`${i.name} render exception:\n\t`+`${e.stack.replace(/\n/g,"\n\t")}`,n.a.ERROR),s++}}this.logging&&this.components.length>0&&n.b.log("Components",n.a.DIVIDER);for(const t in this.components){const i=this.components[t];try{const s=Array.isArray(e)?e[t]:e[i.name];s?await i.initialize(...s):await i.initialize(),this.logging&&n.b.log(`${i.name} initialized!`,n.a.OK)}catch(e){this.logging&&n.b.log(`${i.name} initialization exception:\n\t`+`${e.stack.replace(/\n/g,"\n\t")}`,n.a.ERROR),s++}}this.logging&&(n.b.log("",n.a.DIVIDER),s?n.b.log(`Initialization completed with ${s} exceptions!`,n.a.WARNING):n.b.log("Successfyly initialized!",n.a.OK))}getComponent(e){return this.components.find(t=>t.name.toLowerCase()==e.toLowerCase())||null}getView(e){return this.views.find(t=>t.name.toLowerCase()==e.toLowerCase())||null}close(){this.logging&&(n.b.log("",n.a.DIVIDER),n.b.log("Closing all components..."));let e=0;for(const t of this.components)try{t.close(),this.logging&&n.b.log(`${t.name} closed!`,n.a.OK)}catch(s){this.logging&&n.b.log(`${t.name} closing exception:\n\t`+`${s.stack.replace(/\n/g,"\n\t")}`,n.a.ERROR),e++}this.logging&&(n.b.log("",n.a.DIVIDER),e?n.b.log(`Stopped with ${e} exceptions!`,n.a.WARNING):n.b.log("Successfyly stopped!",n.a.OK))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return Api}));var n=s(7),i=s.n(n),o=s(3);class Api{constructor(e){this.url="https://api.vk.com/method/",this.params={access_token:e,v:"5.101"}}async getFrieds(){const e=await i.a.post(this.url+"friends.get",{form:Object.assign(Object.assign({},this.params),{fields:"last_seen,online"})}),t=JSON.parse(e);if("object"!=typeof t.response)return[];if(!Array.isArray(t.response.items))return[];const s=[];for(const e of t.response.items){if(!e.id||!e.first_name||!e.last_name||"number"!=typeof e.online)continue;let t=void 0;if("object"==typeof e.last_seen){const s=1e3*+e.last_seen.time,n=+e.last_seen.platform||0;t={lastSeen:s?new Date(s):new Date,platform:n}}const n=new o.b(e.id+"",e.first_name+" "+e.last_name,e.online+""=="1",t);s.push(n)}return s}async getOnline(){const e=await i.a.post(this.url+"friends.getOnline",{form:Object.assign(Object.assign({},this.params),{online_mobile:"0"})}),t=JSON.parse(e);return Array.isArray(t.response)?t.response:[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return Envets}));var n=s(1),i=s(4),o=s(0),a=s(6),r=s(5);class Envets extends(Object(n.a)()){static async initialize(){this.registerWatcher(),this.registerSessions(),this.call("registered")}static registerWatcher(){i.a.addEventListener("loggedin",e=>{o.b.log("[1m"+e.name+"[0m back [94monline[0m."),r.a.registerLogIn(e)}),i.a.addEventListener("loggedout",e=>{o.b.log("[1m"+e.name+"[0m left [33moffline[0m."),r.a.registerLogOut(e)}),i.a.addEventListener("created",e=>{a.a.createUser(e)})}static registerSessions(){r.a.addEventListener("sessionfound",e=>{a.a.addSession(e)})}}},function(e,t){e.exports=require("sqlite3")},function(e,t,s){"use strict";s.r(t);var n=s(8),i=s.n(n),o=s(2),a=s.n(o),r=s(0),c=s(9);i.a.config();const l=new c.a;function u(){l.close(),process.exit()}function g(e){const t=(e.stack||"").replace(/\n/g,"\n\t"),s=`./crashes/${(new Date).toDateString()}.txt`,n=`Runtime exception:\n\t${t}`,i=`[${(new Date).toTimeString()}]: ${n}\r\n\r\n`;a.a.existsSync("./crashes")||a.a.mkdirSync("./crashes"),a.a.appendFileSync(s,i),r.b.log(n,r.a.ERROR),l.logging=!1,l.close(),r.b.log("Restarting the script in 3 seconds..."),setTimeout(()=>{l.initialized||l.initialize()},3e3)}process.on("exit",l.close.bind(l)),process.on("SIGINT",u),process.on("SIGUSR1",u),process.on("SIGUSR2",u),process.on("uncaughtException",g),process.on("unhandledRejection",g),l.initialize()}]);